name: Benchmark

on:
  pull_request:
    paths:
      - 'src/**'
      - 'examples/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'bench-config.toml'
      - '.github/workflows/bench.yml'
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Regression threshold percentage'
        required: false
        default: '10.0'

env:
  CARGO_TERM_COLOR: always
  NOIR_VERSION: "1.0.0-beta.11"

jobs:
  bench:
    name: CI Benchmarks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Noir toolchain
        run: |
          curl -L https://raw.githubusercontent.com/noir-lang/noirup/main/install | bash
          echo "$HOME/.nargo/bin" >> $GITHUB_PATH
          $HOME/.nargo/bin/noirup -v ${{ env.NOIR_VERSION }}

      - name: Install Barretenberg
        run: |
          # Download pre-built bb binary
          BB_VERSION="0.82.2"
          curl -L "https://github.com/AztecProtocol/aztec-packages/releases/download/aztec-packages-v${BB_VERSION}/barretenberg-x86_64-linux-gnu.tar.gz" -o bb.tar.gz
          tar -xzf bb.tar.gz
          sudo mv bb /usr/local/bin/bb
          chmod +x /usr/local/bin/bb
          bb --version

      - name: Build noir-bench
        run: cargo build --release

      - name: Compile example circuits
        run: |
          cd examples/simple_hash && nargo compile || true
          cd ../merkle_verify && nargo compile || true
          cd ../range_bits && nargo compile || true

      - name: Download baseline artifact
        id: download-baseline
        uses: actions/download-artifact@v4
        with:
          name: noir-bench-baseline
          path: .
        continue-on-error: true

      - name: Run CI benchmarks
        id: bench
        run: |
          set +e  # Don't exit on error
          THRESHOLD="${{ github.event.inputs.threshold || '10.0' }}"

          ./target/release/noir-bench ci \
            --threshold "$THRESHOLD" \
            --format markdown \
            --output .noir-bench-results.jsonl \
            > bench-report.md 2>&1

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Always show the report
          cat bench-report.md

          # Save for artifact
          cp bench-report.md $GITHUB_STEP_SUMMARY || true

      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = fs.readFileSync('bench-report.md', 'utf8');
            } catch (e) {
              report = '## Benchmark Report\n\n*Failed to generate report*';
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('noir-bench')
            );

            const body = report + '\n\n---\n*Generated by noir-bench CI*';

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: noir-bench-results-${{ github.sha }}
          path: |
            .noir-bench-results.jsonl
            bench-report.md
          retention-days: 30
          if-no-files-found: ignore

      - name: Update baseline (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: noir-bench-baseline
          path: .noir-bench-results.jsonl
          retention-days: 90
          overwrite: true

      - name: Check for regressions
        if: steps.bench.outputs.exit_code != '0' && steps.bench.outputs.exit_code != ''
        run: |
          echo "::error::Benchmark regression detected! See report above."
          exit 1
